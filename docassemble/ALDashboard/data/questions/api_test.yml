---
include:
  - docassemble.ALToolbox:display_template.yml
  - nav.yml
---
modules:
  - docassemble.ALToolbox.llms
---
metadata:
  title: Test API keys
  sessions are unique: True
  required privileges:
    - admin
    - developer
  temporary session: True
---
objects:
  - my_person: Individual
---
mandatory: True
code: |
  address_to_complete
  if my_person.address.address:
    my_person.address.geocode()
  if my_person.email:
    email_success = send_email(to=my_person, subject="Test message from Docassemble", body="Test message body. Thanks for testing with ALDashboard.")
  if my_person.phone_number:
    sms_success = send_sms(to=my_person, body="Test message from Docassemble. Thanks for testing with ALDashboard.")
  if test_chat_message:
    chat_response = chat_completion("you are a helpful assistant", test_chat_message)
  api_results
---
question: |
  Test an API key
subquestion: |
  Quickly test some common API integrations. Make sure you have set up the relevant API keys in your configuration first.
fields:
  - note: |
      ---
      Google Maps

      Server API key: `${ get_config("google", {}).get("api key") }` [BR]
      HTTP/S API key: `${ get_config("google", {}).get("google maps api key") }`
  - Address auto complete: address_to_complete
    address autocomplete: True
    required: False
  - "Address geocoding (enter at least a street address to trigger)": my_person.address.address
    required: False
  - Unit: my_person.address.unit
    required: False
  - City: my_person.address.city
    required: False
  - State: my_person.address.state
    required: False
  - Zip: my_person.address.zip
    required: False
  - County: my_person.address.county
    required: False
  - note: |
      ---
      Email sending

      ```
      ${ get_config("mail") }
      ```
  - Enter an email to get a test message: my_person.email
    datatype: email
    required: False
  - note: |
      % if get_config("error notification email"):
      ${ action_button_html(url_ask("api_test"), label="Trigger an error notification message") }

      Your error notification setting is: `${ get_config("error notification email") }` [BR]
      An error notification email will be sent to that address when you click the button above.

      Make sure to check your SPAM folder if you don't see the message in your inbox.
      % else:      
      You do not have an error notification email address set up in your configuration.
      % endif
  - note: |
      ---
      SMS sending

      ```
      ${ get_config("twilio") }
      ```
  - Enter a phone number to get a test message: my_person.phone_number
    datatype: phone
    required: False
  - note: |
      Chat Completion (OpenAI, Google Gemini, Azure, etc.)

      Will only try the default model specified by llms.py, which
      as of this writing is gpt-5-nano.

      % if user_has_privilege("admin"):
      Dictionary-style config: 

      ```
      ${ get_config("open ai")}
      ```

      Top level style, API key and url: 

      ```
      ${ get_config("openai base url") }
      ${ get_config("openai api key") }      
      ```
      % else:
      Only admins can view the relevant configuration for chat completions.
      % endif

  - Enter a test chat: test_chat_message
    datatype: area
    required: False
---
event: api_test
code: |
  a = 1 / 0
---
event: api_results
question: |
  Results
subquestion: |
  % if my_person.address.address:
  Geocoded: ${ my_person.address.was_geocoded_successfully() } [BR]
  % if my_person.address.was_geocoded_successfully():
  Long address: ${ my_person.address.norm_long.on_one_line() } [BR]
  % endif
  % if hasattr(my_person.address, "county"):
  County: ${ my_person.address.county }
  % endif
  % endif

  % if my_person.email:
  Email success: ${ email_success }
  % endif

  % if my_person.phone_number:
  SMS success: ${ sms_success }
  % endif

  % if test_chat_message:
  Chat response: 
  
  ${ chat_response }
  % endif

  Use the back button to try again
