---
include:
  - docassemble.AssemblyLine:assembly_line.yml
  - nav.yml
---
metadata:
  title: Interview Text Linter
  required privileges:
    - admin
    - developer
---
modules:
  - .interview_linter
  - .aldashboard
---
features:
  css:
    - interview_linter.css
  javascript:
    - interview_linter.js
---
mandatory: True
code: |
  source_mode
  run_ai_checks
  if source_mode == "upload":
    uploaded_yaml_files
  elif source_mode == "installed":
    selected_installed_package
    selected_installed_files
  elif source_mode == "playground":
    selected_playground_project
    selected_playground_files
  lint_reports
  show_results
---
question: |
  Interview text linter
subquestion: |
  Choose where to lint YAML files from.
fields:
  - Source: source_mode
    datatype: radio
    choices:
      - Upload YAML file(s): upload
      - Installed package: installed
      - Playground project: playground
  - Run AI checks?: run_ai_checks
    datatype: yesno
    default: False
    help: |
      Uses the configured `docassemble.ALToolbox.llms` provider and may take longer.
  - Lint mode: lint_mode
    datatype: radio
    default: full
    choices:
      - Full lint checks: full
      - WCAG basic accessibility heuristics: wcag-basic
    help: |
      WCAG mode runs only accessibility-focused heuristic checks.
  - Spellcheck languages: spellcheck_languages
    default: en
    help: |
      Comma-separated language codes for spellcheck, e.g. `en` or `en,es`.
      A word is flagged only if unknown in all selected languages.
---
code: |
  installed_package_map = list_question_files_in_docassemble_packages()
  installed_package_names = sorted(installed_package_map.keys())
---
question: |
  Upload YAML files
fields:
  - YAML files: uploaded_yaml_files
    datatype: files
    accept: |
      ".yml,.yaml,text/yaml,text/x-yaml"
---
question: |
  Select installed package
fields:
  - Package: selected_installed_package
    code: |
      installed_package_names
---
question: |
  Select installed package files to lint
fields:
  - Files: selected_installed_files
    datatype: checkboxes
    required: False
    code: |
      [
        {f"ref:{selected_installed_package}:data/questions/{filename}": filename}
        for filename in sorted(installed_package_map.get(selected_installed_package, []))
        if filename.lower().endswith((".yml", ".yaml"))
      ]
---
question: |
  Select playground project
fields:
  - Playground project: selected_playground_project
    code: |
      list_playground_projects()
---
question: |
  Select playground files to lint
fields:
  - Files: selected_playground_files
    datatype: checkboxes
    required: False
    code: |
      [
        {item["token"]: item["label"]}
        for item in list_playground_yaml_files(selected_playground_project)
      ]
---
code: |
  lint_sources = []
  if source_mode == "upload":
    for yaml_file in uploaded_yaml_files:
      lint_sources.append({"name": yaml_file.filename, "token": yaml_file.path()})
  elif source_mode == "installed":
    for token in selected_installed_files.true_values():
      lint_sources.append({"name": token.replace("ref:", ""), "token": token})
  elif source_mode == "playground":
    for token in selected_playground_files.true_values():
      lint_sources.append({"name": token.split("/")[-1], "token": token})

  lint_reports = lint_multiple_sources(
    lint_sources,
    language=spellcheck_languages,
    include_llm=run_ai_checks,
    lint_mode=lint_mode,
  )
---
code: |
  import html
  import re

  severity_rank = {"red": 0, "yellow": 1, "green": 2}
  severity_label = {"red": "Fix required", "yellow": "Warning", "green": "Advisory"}

  def _safe_id(value, prefix="id"):
    slug = re.sub(r"[^a-zA-Z0-9_-]+", "-", str(value or "").strip().lower())
    slug = re.sub(r"-{2,}", "-", slug).strip("-")
    return slug or prefix

  def _sort_findings(findings):
    return sorted(
      findings,
      key=lambda finding: (
        severity_rank.get(str(finding.get("severity", "")).lower(), 9),
        str(finding.get("screen_id") or ""),
        str(finding.get("rule_id") or ""),
        str(finding.get("message") or ""),
      ),
    )

  lint_reports_ui = []
  for report_idx, report in enumerate(lint_reports):
    name = str(report.get("name") or "unknown")
    file_anchor = f"lint-file-{report_idx}-{_safe_id(name, prefix='file')}"
    error = report.get("error")
    result = report.get("result")

    if error or not result:
      lint_reports_ui.append(
        {
          "name": name,
          "file_anchor": file_anchor,
          "error": error or "Unknown error",
          "counts": {"red": 0, "yellow": 0, "green": 0},
          "priority_findings": [],
          "screens": [],
          "orphan_findings": [],
          "misspelled": [],
          "headings_warnings": [],
          "style_warnings": [],
          "readability": {"consensus": "N/A", "severity": None, "warning": None},
        }
      )
      continue

    findings = _sort_findings(result.get("findings", []))
    counts = {
      "red": len(result.get("findings_by_severity", {}).get("red", [])),
      "yellow": len(result.get("findings_by_severity", {}).get("yellow", [])),
      "green": len(result.get("findings_by_severity", {}).get("green", [])),
    }
    screen_catalog = result.get("screen_catalog", [])
    by_screen = {str(screen.get("screen_id") or ""): [] for screen in screen_catalog}
    orphan_findings = []

    for finding in findings:
      screen_id = str(finding.get("screen_id") or "")
      if screen_id and screen_id in by_screen:
        by_screen[screen_id].append(finding)
      else:
        orphan_findings.append(finding)

    screens = []
    for screen in screen_catalog:
      screen_id = str(screen.get("screen_id") or "")
      screen_findings = by_screen.get(screen_id, [])
      if not screen_findings:
        continue
      screen_anchor = f"{file_anchor}-screen-{_safe_id(screen_id, prefix='screen')}"
      screens.append(
        {
          "screen_id": screen_id,
          "screen_anchor": screen_anchor,
          "yaml_text": str(screen.get("yaml_text") or ""),
          "findings": screen_findings,
        }
      )

    priority_findings = findings[:6]

    lint_reports_ui.append(
      {
        "name": name,
        "file_anchor": file_anchor,
        "error": None,
        "counts": counts,
        "priority_findings": priority_findings,
        "screens": screens,
        "orphan_findings": orphan_findings,
        "misspelled": result.get("misspelled", []),
        "headings_warnings": result.get("headings_warnings", []),
        "style_warnings": result.get("style_warnings", []),
        "readability": result.get("readability", {}),
      }
    )
---
event: show_results
question: |
  Interview Suggestions
subquestion: |
  % if not lint_reports_ui:
  No files were selected.
  % endif

  <section class="al-lint-results">
      % for report in lint_reports_ui:
      <details id="${ report['file_anchor'] }" open>
        <summary>
          ${ html.escape(report['name']) }
          <span class="al-lint-badge red">Red ${ report['counts']['red'] }</span>
          <span class="al-lint-badge yellow">Yellow ${ report['counts']['yellow'] }</span>
          <span class="al-lint-badge green">Green ${ report['counts']['green'] }</span>
        </summary>
        <div class="al-lint-file-body">
          <div>
            % if report['error']:
            <div class="al-lint-finding red">${ html.escape(report['error']) }</div>
            % else:
            <div class="al-lint-priority-inline">
              <strong>Priority:</strong>
              % if report['priority_findings']:
              % for finding in report['priority_findings']:
              <a class="al-lint-priority-item" href="#${ report['file_anchor'] }-screen-${ _safe_id(finding.get('screen_id'), prefix='screen') if finding.get('screen_id') else report['file_anchor'] }">
                <span class="al-lint-badge ${ str(finding.get('severity') or 'yellow') }">${ html.escape(severity_label.get(str(finding.get('severity') or '').lower(), 'Warning')) }</span>
                % if finding.get('screen_id'):
                <code>${ html.escape(str(finding.get('screen_id'))) }</code>
                % else:
                <code>general</code>
                % endif
              </a>
              % endfor
              % else:
              <span>No findings.</span>
              % endif
            </div>
            <div class="al-lint-meta-line">
              Readability: <strong>${ html.escape(str(report['readability'].get('consensus', 'N/A'))) }</strong>
              % if report['readability'].get('warning'):
              <span class="al-lint-badge ${ report['readability'].get('severity') or 'yellow' }">${ html.escape(str(report['readability'].get('warning')))}</span>
              % endif
            </div>
            % if report['misspelled']:
            <div class="al-lint-meta-line">Misspelled: ${ html.escape(", ".join(report['misspelled'][:25])) }</div>
            % endif
            % if not report['error']:
            % for screen in report['screens']:
            <article class="al-lint-screen" id="${ screen['screen_anchor'] }">
              <div class="al-lint-screen-header">
                <strong>Section</strong>
                <span class="al-lint-screen-id" title="Triple-click to toggle highlight and select this id">${ html.escape(screen['screen_id']) }</span>
              </div>

              % for finding in screen['findings']:
              <div class="al-lint-finding ${ str(finding.get('severity') or 'yellow') }">
                <span class="al-lint-badge ${ str(finding.get('severity') or 'yellow') }">${ html.escape(severity_label.get(str(finding.get('severity') or '').lower(), 'Warning')) }</span>
                ${ "âœ¨ " if finding.get("source") == "llm" else "" }${ html.escape(str(finding.get('message') or '')) }
                % if finding.get("confidence"):
                <em>(confidence: ${ html.escape(str(finding.get("confidence"))) })</em>
                % endif
                % if finding.get("url"):
                <a href="${ html.escape(str(finding.get('url'))) }" target="_blank" rel="noopener noreferrer">Reference</a>
                % endif
                % if finding.get("problematic_text"):
                <div class="al-lint-problem">${ html.escape(str(finding.get("problematic_text"))) }</div>
                % endif
              </div>
              % endfor

              <div class="al-lint-yaml">
                <pre>${ html.escape(screen['yaml_text']) }</pre>
              </div>
            </article>
            % endfor

            % if not report['screens'] and not report['orphan_findings']:
            <article class="al-lint-screen">
              <div class="al-lint-empty">No findings in this file.</div>
            </article>
            % endif

            % if report['orphan_findings']:
            <article class="al-lint-screen">
              <div class="al-lint-screen-header"><strong>General findings (no section id)</strong></div>
              % for finding in report['orphan_findings']:
              <div class="al-lint-finding ${ str(finding.get('severity') or 'yellow') }">
                <span class="al-lint-badge ${ str(finding.get('severity') or 'yellow') }">${ html.escape(severity_label.get(str(finding.get('severity') or '').lower(), 'Warning')) }</span>
                ${ html.escape(str(finding.get('message') or '')) }
                % if finding.get("url"):
                <a href="${ html.escape(str(finding.get('url'))) }" target="_blank" rel="noopener noreferrer">Reference</a>
                % endif
                % if finding.get("problematic_text"):
                <div class="al-lint-problem">${ html.escape(str(finding.get("problematic_text"))) }</div>
                % endif
              </div>
              % endfor
            </article>
            % endif

            % if report['headings_warnings'] or report['style_warnings']:
            <article class="al-lint-screen">
              <div class="al-lint-screen-header"><strong>Additional warnings</strong></div>
              % for warning in report['headings_warnings']:
              <div class="al-lint-finding yellow">${ html.escape(str(warning)) }</div>
              % endfor
              % for warning in report['style_warnings']:
              <div class="al-lint-finding yellow">${ html.escape(str(warning.get("message") or "")) } <a href="${ html.escape(str(warning.get('url') or '')) }" target="_blank" rel="noopener noreferrer">Read more</a></div>
              % endfor
            </article>
            % endif
            % endif
            % endif
          </div>
        </div>
      </details>
      % endfor
  </section>
---
template: text_used
subject: |
    Text used
content: |
    % for report in lint_reports:
    % if report.get('result'):
    ### ${ report['name'] }
    % for screen in report['result']["screen_catalog"]:
    #### Screen `${ screen['screen_id'] }`
    ```yaml
    ${ screen.get('yaml_text', '') }
    ```
    % endfor
    % endif
    % endfor
