---
include:
  - nav.yml
---
metadata:
  title: Interview Text Linter
---
modules:
  - .interview_linter
---
mandatory: True
code: |
  upload_yaml
  lint_results
  show_results
---
question: |
  Upload a YAML interview file
fields:
  - YAML file: upload_yaml
    datatype: file
  - Run AI checks?: run_ai_checks
    datatype: yesno
    default: False
    help: |
      Uses the configured `docassemble.ALToolbox.llms` provider and may take longer.
---
code: |
  lint_results = lint_interview_content(upload_yaml.slurp(), include_llm=run_ai_checks)
---
event: show_results
question: |
  Interview Suggestions
subquestion: |
  % if lint_results["findings_by_severity"]["red"] or lint_results["findings_by_severity"]["yellow"] or lint_results["findings_by_severity"]["green"]:
  ### Findings

  % if lint_results["findings_by_severity"]["red"]:
  #### Red (fix required)
  % for finding in lint_results["findings_by_severity"]["red"]:
  * ${ "✨ " if finding.get("source") == "llm" else "" }${ finding["message"] }${ " (screen: `" + str(finding["screen_id"]) + "`)" if finding.get("screen_id") else "" } [Reference](${ finding["url"] })${ " [Go to screen](" + finding["screen_link"] + ")" if finding.get("screen_link") else "" }
    % if finding.get("problematic_text"):
    Problematic text: `${ finding["problematic_text"] }`
    % endif
  % endfor
  % endif

  % if lint_results["findings_by_severity"]["yellow"]:
  #### Yellow (warning)
  % for finding in lint_results["findings_by_severity"]["yellow"]:
  * ${ "✨ " if finding.get("source") == "llm" else "" }${ finding["message"] }${ " (screen: `" + str(finding["screen_id"]) + "`)" if finding.get("screen_id") else "" } [Reference](${ finding["url"] })${ " [Go to screen](" + finding["screen_link"] + ")" if finding.get("screen_link") else "" }
    % if finding.get("problematic_text"):
    Problematic text: `${ finding["problematic_text"] }`
    % endif
  % endfor
  % endif

  % if lint_results["findings_by_severity"]["green"]:
  #### Green (advisory)
  % for finding in lint_results["findings_by_severity"]["green"]:
  * ${ "✨ " if finding.get("source") == "llm" else "" }${ finding["message"] }${ " (screen: `" + str(finding["screen_id"]) + "`)" if finding.get("screen_id") else "" } [Reference](${ finding["url"] })${ " [Go to screen](" + finding["screen_link"] + ")" if finding.get("screen_link") else "" }
    % if finding.get("problematic_text"):
    Problematic text: `${ finding["problematic_text"] }`
    % endif
  % endfor
  % endif
  % endif

  ### Readability
  * Consensus: ${ lint_results["readability"]["consensus"] }
  % if lint_results["readability"]["severity"] == "red":
  * **Red warning:** ${ lint_results["readability"]["warning"] }
  % elif lint_results["readability"]["severity"] == "yellow":
  * **Yellow warning:** ${ lint_results["readability"]["warning"] }
  % endif
  
  % if lint_results["misspelled"]:
  ### Misspelled words
  
  It looks like these words are misspelled:
  
  % for misspelled_word in lint_results["misspelled"]:
  * ${ misspelled_word }
  % endfor
  % endif
  
  % if lint_results["headings_warnings"] or lint_results["style_warnings"]:
  ### Warnings
  
  % for warning in lint_results["headings_warnings"]:
  * ${ warning }
  % endfor
  
  % for warning in lint_results["style_warnings"]:
  * ${ warning["message"] } [Read more](${ warning["url"] })
  % endfor
  % endif
help:
  label: |
    Text used
  content: |
    % for screen in lint_results["screen_catalog"]:
    <a id="${ screen['anchor'] }"></a>
    ### Screen `${ screen['screen_id'] }`
    
    ${ screen['text'] }
    
    ---
    <br>
    % endfor
    
    % if not lint_results["screen_catalog"]:
    % for text in lint_results["interview_texts"]:
  
    ${ text }
  
    ---
    <br>
    % endfor
    % endif
